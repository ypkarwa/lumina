// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL") // Uses connection pooling
  directUrl = env("POSTGRES_PRISMA_POSTGRES_URL_NON_POOLING") // Uses a direct connection
}

model User {
  id           String   @id @default(uuid())
  phoneNumber  String   @unique
  name         String?
  createdAt    DateTime @default(now())
  
  // Scores
  valueScore   Int      @default(0) // Gold Score (from Feedback/Advice)
  spiritScore  Int      @default(0) // Spirit Score (from Praises)

  // Monthly Stamp Quota (Resets monthly)
  praiseStamps   Int    @default(2)
  feedbackStamps Int    @default(1)
  adviceStamps   Int    @default(1)

  // Onboarding
  tourCompleted  Boolean @default(false) // Has user completed the app tour?

  // Relations
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  comments         Comment[]
  agrees           Agree[]
  polls            Poll[]
}

model Message {
  id          String   @id @default(uuid())
  content     String
  actionPoint String?  // "Suggested Next Step"
  type        String   // PRAISE, FEEDBACK, ADVICE
  
  senderId    String
  sender      User     @relation("SentMessages", fields: [senderId], references: [id])
  
  recipientPhone String
  recipientId    String? // Optional until recipient joins
  recipient      User?   @relation("ReceivedMessages", fields: [recipientId], references: [id])

  // Trust & Safety
  status      String   @default("COOLING_OFF") // COOLING_OFF, DELIVERED, RETRACTED
  createdAt   DateTime @default(now())
  availableAt DateTime // createdAt + 10 minutes

  isPublic    Boolean  @default(false) // "Wall of Growth"
  isAnonymous Boolean  @default(false)
  notificationSent Boolean @default(false) // WhatsApp notification sent after cooling
  
  ratings     Rating[]
  comments    Comment[]
  agrees      Agree[]
}

model Rating {
  id        String   @id @default(uuid())
  score     Int      // 1-5
  type      String   // VALUE or LOVE
  
  messageId String
  message   Message  @relation(fields: [messageId], references: [id])
}

model Comment {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  messageId String?
  message   Message?  @relation(fields: [messageId], references: [id])

  pollId    String?
  poll      Poll?     @relation(fields: [pollId], references: [id])
}

model Agree {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  messageId String
  message   Message  @relation(fields: [messageId], references: [id])

  @@unique([userId, messageId]) // One agree per user per message
}

model Poll {
  id        String   @id @default(uuid())
  question  String
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  answers   PollAnswer[]
  comments  Comment[]
}

model PollAnswer {
  id        String   @id @default(uuid())
  answer    String
  createdAt DateTime @default(now())
  pollId    String
  poll      Poll     @relation(fields: [pollId], references: [id])
  
  // Who answered? (Optional if anonymous)
  responderPhone String? 
}
